{% extends 'base.html' %}

{% block title %}{{ event.title }} - –§–æ—Ç–æ–∞—Ä—Ö–∏–≤ —à–∫–æ–ª—ã ‚Ññ2086{% endblock %}

{% block content %}
<div style="margin-bottom: 30px;">
    <nav style="margin-bottom: 20px; font-size: 14px; color: #666;">
        <a href="{% url 'home' %}" style="color: #cb5603; text-decoration: none;">–ì–ª–∞–≤–Ω–∞—è</a>
        &nbsp;‚Üí&nbsp;
        <a href="{% url 'year_detail' event.school_class.year_album.id %}" style="color: #cb5603; text-decoration: none;">{{ event.school_class.year_album.year }}</a>
        &nbsp;‚Üí&nbsp;
        <a href="{% url 'class_detail' event.school_class.id %}" style="color: #cb5603; text-decoration: none;">{{ event.school_class.class_name }}</a>
        &nbsp;‚Üí&nbsp;
        <span>{{ event.title }}</span>
    </nav>

    <!-- –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–æ–±—ã—Ç–∏—è -->
    <div style="text-align: center; margin-bottom: 40px;">
        <h1 class="page-title" style="margin-bottom: 10px; color: #000;">{{ event.title }}</h1>
        <p style="color: #666; font-size: 18px; margin: 0;">
            –ö–ª–∞—Å—Å: {{ event.school_class.class_name }} ‚Ä¢ –£—á–µ–±–Ω—ã–π –≥–æ–¥: {{ event.school_class.year_album.year }}
        </p>
    </div>
</div>

{% if photos %}
<!-- –£–ë–ò–†–ê–ï–ú –≤–µ—Ä—Ö–Ω—é—é –∫–Ω–æ–ø–∫—É –∫–æ–≥–¥–∞ —Ñ–æ—Ç–æ —É–∂–µ –µ—Å—Ç—å -->
<div class="photos-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
    {% for photo in photos %}
    <div class="photo-thumbnail" style="position: relative; cursor: pointer; background: #f8f9fa; padding: 15px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: all 0.3s ease; border: 1px solid #e0e0e0;">
        <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è/–∞–¥–º–∏–Ω–∞ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏) -->
        {% if user.is_authenticated and user == photo.uploaded_by or user.is_staff or user.is_superuser %}
        <a href="{% url 'delete_photo' photo.id %}" 
           class="delete-btn"
           style="position: absolute; top: 10px; right: 10px; background: rgba(220, 53, 69, 0.9); color: white; padding: 8px 10px; border-radius: 4px; text-decoration: none; font-size: 14px; z-index: 10; opacity: 0; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; width: 36px; height: 36px; border: 1px solid rgba(255,255,255,0.3);">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
        </a>
        {% endif %}
        
        <div onclick="openPhotoSwipe({{ forloop.counter0 }})" style="transition: all 0.3s ease;">
            {% if photo.image %}
                <img src="{{ photo.image.url }}"
                     alt="–§–æ—Ç–æ {{ photo.id }}"
                     style="width: 100%; height: 200px; object-fit: cover; border-radius: 6px; margin-bottom: 10px;">
            {% endif %}
            <div style="color: #666; font-size: 12px; text-align: center;">
                –§–æ—Ç–æ #{{ forloop.counter }}
            </div>
        </div>
    </div>
    {% endfor %}
    
    <!-- –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ –∫–∞–∫ —ç–ª–µ–º–µ–Ω—Ç —Å–µ—Ç–∫–∏ -->
    {% if user.is_authenticated %}
    <div class="add-photo-card" onclick="location.href='{% url 'upload_photo_for_event' event.id %}'">
        <div class="add-card-content">
            <span class="add-card-icon">+</span>
            <span class="add-card-text">–î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
        </div>
    </div>
    {% endif %}
</div>

<!-- Root element of PhotoSwipe -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>
    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>

{% else %}
<!-- –°–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–≥–¥–∞ —Ñ–æ—Ç–æ –Ω–µ—Ç - –ë–û–õ–¨–®–ê–Ø –ö–í–ê–î–†–ê–¢–ù–ê–Ø –ö–ù–û–ü–ö–ê -->
<div class="empty-state">
    <div class="empty-icon">üñºÔ∏è</div>
    <h3>–ü–æ–∫–∞ –Ω–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</h3>
    <p>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>
    {% if user.is_authenticated %}
    <a href="{% url 'upload_photo_for_event' event.id %}" class="add-photo-card-large">
        <span class="add-card-icon">+</span>
        <span class="add-card-text">–î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ</span>
    </a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
/* –°—Ç–∏–ª–∏ –¥–ª—è –ö–í–ê–î–†–ê–¢–ù–´–• –∫–Ω–æ–ø–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ */
/* –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —Å–µ—Ç–∫–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π */
.add-photo-card {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 10px;
    text-align: center;
    transition: all 0.3s ease;
    border: 2px dashed #cb5603;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    min-height: 250px;
}

.add-photo-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(0,0,0,0.1);
    background: #fff;
    border-color: #a84502;
    border-style: solid;
}

/* –ë–æ–ª—å—à–∞—è –∫–≤–∞–¥—Ä–∞—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
.add-photo-card-large {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    background: #f8f9fa;
    color: #cb5603;
    text-decoration: none;
    padding: 25px 50px;
    border-radius: 12px;
    font-size: 20px;
    font-weight: 600;
    box-shadow: 0 6px 20px rgba(203, 86, 3, 0.2);
    transition: all 0.3s ease;
    border: 2px dashed #cb5603;
    cursor: pointer;
    min-width: 300px;
}

.add-photo-card-large:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(203, 86, 3, 0.3);
    background: #fff;
    border-color: #a84502;
    border-style: solid;
    color: #a84502;
}

.add-card-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
}

.add-card-icon {
    font-size: 36px;
    color: #cb5603;
    font-weight: 300;
    line-height: 1;
}

.add-card-text {
    font-size: 16px;
    font-weight: 600;
    color: #cb5603;
    text-align: center;
}

.add-photo-card:hover .add-card-icon,
.add-photo-card:hover .add-card-text,
.add-photo-card-large:hover .add-card-icon,
.add-photo-card-large:hover .add-card-text {
    color: #a84502;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—É—Å—Ç—ã—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π */
.empty-state {
    text-align: center;
    padding: 80px 40px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    margin: 40px 0;
}

.empty-icon {
    font-size: 80px;
    margin-bottom: 30px;
    opacity: 0.8;
}

.empty-state h3 {
    color: #333;
    margin-bottom: 20px;
    font-size: 28px;
    font-weight: 600;
}

.empty-state p {
    color: #666;
    margin-bottom: 40px;
    font-size: 18px;
    line-height: 1.5;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–∏–Ω–∏–∞—Ç—é—Ä —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π */
.photo-thumbnail {
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.photo-thumbnail:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    background: #fff !important;
}

/* –£–ª—É—á—à–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ PhotoSwipe */
.pswp__img {
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
}

/* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è */
.delete-btn {
    transition: all 0.3s ease !important;
    border: 1px solid rgba(255,255,255,0.3);
}

.delete-btn:hover {
    background: rgba(220, 53, 69, 1) !important;
    transform: scale(1.1);
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
}

@media (max-width: 768px) {
    .add-photo-card {
        min-height: 200px;
        padding: 20px 15px;
    }
    
    .add-photo-card-large {
        padding: 20px 30px;
        font-size: 18px;
        min-width: 250px;
    }
    
    .empty-state {
        padding: 60px 20px;
        margin: 20px 0;
    }
    
    .empty-icon {
        font-size: 60px;
    }
    
    .empty-state h3 {
        font-size: 24px;
    }
    
    .empty-state p {
        font-size: 16px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// ... (–≤–µ—Å—å JavaScript –∫–æ–¥ –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function getImageSize(src) {
    return new Promise(function(resolve, reject) {
        var img = new Image();
        img.onload = function() {
            resolve({
                width: this.naturalWidth,
                height: this.naturalHeight
            });
        };
        img.onerror = reject;
        img.src = src;
    });
}

// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è PhotoSwipe
var photoSwipeItems = [
    {% for photo in photos %}
    {
        src: "{{ photo.image.url }}",
        w: 0,
        h: 0,
        title: '–§–æ—Ç–æ {{ forloop.counter }} –∏–∑ {{ photos|length }}<br>–ó–∞–≥—Ä—É–∂–µ–Ω–æ: {{ photo.uploaded_by.username }} ({{ photo.uploaded_at|date:"d.m.Y H:i" }})'
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

function openPhotoSwipe(index) {
    var pswpElement = document.querySelectorAll('.pswp')[0];

    // –û–ø—Ü–∏–∏ –¥–ª—è PhotoSwipe
    var options = {
        index: parseInt(index),
        bgOpacity: 0.9,
        showHideOpacity: true,
        closeOnScroll: false,
        history: false,
        shareEl: false,
        fullscreenEl: true,
        zoomEl: true,
        maxSpreadZoom: 3,
        getDoubleTapZoom: function(isMouseClick, item) {
            return item.initialZoomLevel < 0.7 ? 1 : 1.5;
        },
        imageClickAction: 'zoom',
        tapToToggleControls: true,
        pinchToClose: false
    };

    var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, photoSwipeItems, options);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    gallery.listen('gettingData', function(index, item) {
        if (item.w < 1 || item.h < 1) {
            getImageSize(item.src).then(function(size) {
                item.w = size.width;
                item.h = size.height;
                gallery.invalidateCurrItems();
                gallery.updateSize(true);
            }).catch(function() {
                item.w = 1200;
                item.h = 800;
                gallery.invalidateCurrItems();
                gallery.updateSize(true);
            });
        }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä—è—á—É—é –∫–ª–∞–≤–∏—à—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    gallery.listen('afterInit', function() {
        document.addEventListener('keydown', function(e) {
            if (e.key === 'd' || e.key === 'D') {
                e.preventDefault();
                downloadCurrentImage(gallery);
            }
        });
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–ª–µ—Å–∏–∫–æ–º –º—ã—à–∏
    gallery.listen('mouseUsed', function() {
        var frame = gallery.currItem.holder;
        if (frame) {
            frame.addEventListener('wheel', function(e) {
                e.preventDefault();
                if (e.ctrlKey) {
                    var delta = e.deltaY > 0 ? -0.2 : 0.2;
                    var newZoom = Math.max(0.5, Math.min(3, gallery.currItem.initialZoomLevel + delta));
                    gallery.zoomTo(newZoom, {x: e.clientX, y: e.clientY}, 200);
                } else {
                    if (gallery.currItem.initialZoomLevel > 1) {
                        var currentPanY = gallery.currItem.pan.y;
                        gallery.currItem.pan.y = currentPanY - e.deltaY * 0.5;
                        gallery.updateCurrItem();
                    }
                }
            }, { passive: false });
        }
    });

    gallery.init();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function downloadCurrentImage(gallery) {
    if (!gallery) return;

    var item = gallery.currItem;
    var currentIndex = gallery.getCurrentIndex();
    var link = document.createElement('a');
    link.href = item.src;
    link.download = 'photo_' + (currentIndex + 1) + '.jpg';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showDownloadNotification(gallery);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
function showDownloadNotification(gallery) {
    var counterEl = gallery.ui.element.querySelector('.pswp__counter');
    if (counterEl) {
        var originalText = counterEl.textContent;
        counterEl.textContent = '–°–∫–∞—á–∏–≤–∞–Ω–∏–µ...';
        counterEl.style.color = '#4CAF50';

        setTimeout(function() {
            counterEl.textContent = originalText;
            counterEl.style.color = '';
        }, 800);
    }
}

// –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –º–∏–Ω–∏–∞—Ç—é—Ä—ã (–≤–∫–ª—é—á–∞—è –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è)
document.addEventListener('DOMContentLoaded', function() {
    var thumbnails = document.querySelectorAll('.photo-thumbnail');
    thumbnails.forEach(function(thumb, index) {
        thumb.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
            this.style.background = '#fff !important';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
            var deleteBtn = this.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.style.opacity = '1';
            }
        });
        
        thumb.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 4px 6px rgba(0,0,0,0.05)';
            this.style.background = '#f8f9fa !important';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
            var deleteBtn = this.querySelector('.delete-btn');
            if (deleteBtn) {
                deleteBtn.style.opacity = '0';
            }
        });
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞–≤–µ–¥–µ–Ω–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ñ–æ—Ç–æ
    var addPhotoCard = document.querySelector('.add-photo-card');
    if (addPhotoCard) {
        addPhotoCard.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
            this.style.boxShadow = '0 8px 20px rgba(0,0,0,0.15)';
            this.style.background = '#fff !important';
        });
        
        addPhotoCard.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 4px 6px rgba(0,0,0,0.05)';
            this.style.background = '#f8f9fa !important';
        });
    }
});
</script>
{% endblock %}
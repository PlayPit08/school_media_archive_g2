{% extends 'base.html' %}

{% block title %}{{ event.title }} - –§–æ—Ç–æ–∞—Ä—Ö–∏–≤ —à–∫–æ–ª—ã ‚Ññ2086{% endblock %}

{% block content %}
<div style="margin-bottom: 30px;">
    <nav style="margin-bottom: 15px; font-size: 14px; color: #666;">
        <a href="{% url 'home' %}" style="color: #cb5603; text-decoration: none;">–ì–ª–∞–≤–Ω–∞—è</a>
        &nbsp;‚Üí&nbsp;
        <a href="{% url 'year_detail' event.school_class.year_album.id %}" style="color: #cb5603; text-decoration: none;">{{ event.school_class.year_album.year }}</a>
        &nbsp;‚Üí&nbsp;
        <a href="{% url 'class_detail' event.school_class.id %}" style="color: #cb5603; text-decoration: none;">{{ event.school_class.class_name }}</a>
        &nbsp;‚Üí&nbsp;
        <span>{{ event.title }}</span>
    </nav>

    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 class="page-title" style="margin-bottom: 0;">{{ event.title }}</h1>
            <p style="color: #666; margin-top: 5px;">
                –ö–ª–∞—Å—Å: {{ event.school_class.class_name }} ‚Ä¢
                –£—á–µ–±–Ω—ã–π –≥–æ–¥: {{ event.school_class.year_album.year }}
            </p>
        </div>
        <a href="{% url 'class_detail' event.school_class.id %}" class="btn" style="background: #6c757d; color: white; padding: 10px 20px; border-radius: 4px; text-decoration: none;">
            ‚Üê –ù–∞–∑–∞–¥ –∫ –∫–ª–∞—Å—Å—É
        </a>
    </div>
</div>

{% if photos %}
<!-- –ú–∏–Ω–∏–∞—Ç—é—Ä—ã —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π -->
<div class="photos-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
    {% for photo in photos %}
    <div class="photo-thumbnail"
         style="background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; cursor: pointer; transition: all 0.3s ease;"
         onclick="openPhotoSwipe({{ forloop.counter0 }})">
        {% if photo.image %}
            <img src="{{ photo.image.url }}"
                 alt="–§–æ—Ç–æ {{ photo.id }}"
                 style="width: 100%; height: 150px; object-fit: cover; border-radius: 6px; margin-bottom: 8px;">
        {% endif %}
        <div style="color: #666; font-size: 11px;">
            –§–æ—Ç–æ #{{ forloop.counter }}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Root element of PhotoSwipe -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="pswp__bg"></div>
    <div class="pswp__scroll-wrap">
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>

{% else %}
<div style="text-align: center; padding: 60px 20px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">
    <div style="font-size: 48px; margin-bottom: 20px;">üñºÔ∏è</div>
    <h3 style="color: #666; margin-bottom: 15px;">–ü–æ–∫–∞ –Ω–µ—Ç —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π</h3>
    <p style="color: #888; margin-bottom: 25px;">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Å–æ–±—ã—Ç–∏—è –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>
    {% if user.is_authenticated %}
    <a href="{% url 'upload_photo_for_event' event.id %}" class="btn" style="background: #cb5603; color: white; padding: 12px 24px; border-radius: 6px; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
        ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
    </a>
    {% endif %}
</div>
{% endif %}
{% endblock %}

<!-- –û—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ JavaScript –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
{% block extra_js %}
<script>
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function getImageSize(src) {
    return new Promise(function(resolve, reject) {
        var img = new Image();
        img.onload = function() {
            resolve({
                width: this.naturalWidth,
                height: this.naturalHeight
            });
        };
        img.onerror = reject;
        img.src = src;
    });
}

// –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è PhotoSwipe
var photoSwipeItems = [
    {% for photo in photos %}
    {
        src: "{{ photo.image.url }}",
        w: 0,
        h: 0,
        title: '–§–æ—Ç–æ {{ forloop.counter }} –∏–∑ {{ photos|length }}<br>–ó–∞–≥—Ä—É–∂–µ–Ω–æ: {{ photo.uploaded_by.username }} ({{ photo.uploaded_at|date:"d.m.Y H:i" }})'
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

function openPhotoSwipe(index) {
    var pswpElement = document.querySelectorAll('.pswp')[0];

    // –û–ø—Ü–∏–∏ –¥–ª—è PhotoSwipe
    var options = {
        index: parseInt(index),
        bgOpacity: 0.9,
        showHideOpacity: true,
        closeOnScroll: false,
        history: false,
        shareEl: false,
        fullscreenEl: true,
        zoomEl: true,
        maxSpreadZoom: 3,
        getDoubleTapZoom: function(isMouseClick, item) {
            return item.initialZoomLevel < 0.7 ? 1 : 1.5;
        },
        imageClickAction: 'zoom',
        tapToToggleControls: true,
        pinchToClose: false
    };

    var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, photoSwipeItems, options);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    gallery.listen('gettingData', function(index, item) {
        if (item.w < 1 || item.h < 1) {
            getImageSize(item.src).then(function(size) {
                item.w = size.width;
                item.h = size.height;
                gallery.invalidateCurrItems();
                gallery.updateSize(true);
            }).catch(function() {
                item.w = 1200;
                item.h = 800;
                gallery.invalidateCurrItems();
                gallery.updateSize(true);
            });
        }
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ä—è—á—É—é –∫–ª–∞–≤–∏—à—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    gallery.listen('afterInit', function() {
        document.addEventListener('keydown', function(e) {
            if (e.key === 'd' || e.key === 'D') {
                e.preventDefault();
                downloadCurrentImage(gallery);
            }
        });
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–ª–µ—Å–∏–∫–æ–º –º—ã—à–∏
    gallery.listen('mouseUsed', function() {
        var frame = gallery.currItem.holder;
        if (frame) {
            frame.addEventListener('wheel', function(e) {
                e.preventDefault();
                if (e.ctrlKey) {
                    var delta = e.deltaY > 0 ? -0.2 : 0.2;
                    var newZoom = Math.max(0.5, Math.min(3, gallery.currItem.initialZoomLevel + delta));
                    gallery.zoomTo(newZoom, {x: e.clientX, y: e.clientY}, 200);
                } else {
                    if (gallery.currItem.initialZoomLevel > 1) {
                        var currentPanY = gallery.currItem.pan.y;
                        gallery.currItem.pan.y = currentPanY - e.deltaY * 0.5;
                        gallery.updateCurrItem();
                    }
                }
            }, { passive: false });
        }
    });

    gallery.init();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
function downloadCurrentImage(gallery) {
    if (!gallery) return;

    var item = gallery.currItem;
    var currentIndex = gallery.getCurrentIndex();
    var link = document.createElement('a');
    link.href = item.src;
    link.download = 'photo_' + (currentIndex + 1) + '.jpg';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showDownloadNotification(gallery);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
function showDownloadNotification(gallery) {
    var counterEl = gallery.ui.element.querySelector('.pswp__counter');
    if (counterEl) {
        var originalText = counterEl.textContent;
        counterEl.textContent = '–°–∫–∞—á–∏–≤–∞–Ω–∏–µ...';
        counterEl.style.color = '#4CAF50';

        setTimeout(function() {
            counterEl.textContent = originalText;
            counterEl.style.color = '';
        }, 800);
    }
}

// –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –º–∏–Ω–∏–∞—Ç—é—Ä—ã
document.addEventListener('DOMContentLoaded', function() {
    var thumbnails = document.querySelectorAll('.photo-thumbnail');
    thumbnails.forEach(function(thumb, index) {
        thumb.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        });
        thumb.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
        });
    });
});
</script>

<style>
.photo-thumbnail {
    transition: all 0.3s ease;
}

.photo-thumbnail:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* –£–ª—É—á—à–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ PhotoSwipe */
.pswp__img {
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
}
</style>
{% endblock %}
